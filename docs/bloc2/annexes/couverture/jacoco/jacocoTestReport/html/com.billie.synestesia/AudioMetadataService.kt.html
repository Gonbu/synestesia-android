<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AudioMetadataService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.billie.synestesia</a> &gt; <span class="el_source">AudioMetadataService.kt</span></div><h1>AudioMetadataService.kt</h1><pre class="source lang-java linenums">package com.billie.synestesia

import android.media.MediaMetadataRetriever
import com.billie.synestesia.utils.LogUtils
import java.io.File

object AudioMetadataService {

    /**
     * Récupère la durée d'un fichier audio en millisecondes
     * @param audioPath Chemin local du fichier audio
     * @return Durée en millisecondes, ou 0L si impossible à récupérer
     */
    fun getAudioDuration(audioPath: String): Long {
<span class="nc" id="L15">        return try {</span>
<span class="nc" id="L16">            val retriever = MediaMetadataRetriever()</span>
<span class="nc" id="L17">            retriever.setDataSource(audioPath)</span>

<span class="nc" id="L19">            val durationStr = retriever.extractMetadata(</span>
<span class="nc" id="L20">                MediaMetadataRetriever.METADATA_KEY_DURATION</span>
            )
<span class="nc bnc" id="L22" title="All 4 branches missed.">            val duration = durationStr?.toLongOrNull() ?: 0L</span>

<span class="nc" id="L24">            retriever.release()</span>
<span class="nc" id="L25">            duration</span>
<span class="nc" id="L26">        } catch (e: Exception) {</span>
<span class="nc" id="L27">            LogUtils.e(&quot;Erreur lors de la récupération de la durée audio: &quot;, e)</span>
<span class="nc" id="L28">            0L</span>
        }
    }

    /**
     * Récupère la durée d'un fichier audio depuis une URL
     * @param audioUrl URL du fichier audio
     * @return Durée en millisecondes, ou 0L si impossible à récupérer
     */
    fun getAudioDurationFromUrl(audioUrl: String): Long {
<span class="nc" id="L38">        return try {</span>
<span class="nc" id="L39">            val retriever = MediaMetadataRetriever()</span>
<span class="nc" id="L40">            retriever.setDataSource(audioUrl, HashMap())</span>

<span class="nc" id="L42">            val durationStr = retriever.extractMetadata(</span>
<span class="nc" id="L43">                MediaMetadataRetriever.METADATA_KEY_DURATION</span>
            )
<span class="nc bnc" id="L45" title="All 4 branches missed.">            val duration = durationStr?.toLongOrNull() ?: 0L</span>

<span class="nc" id="L47">            retriever.release()</span>
<span class="nc" id="L48">            duration</span>
<span class="nc" id="L49">        } catch (e: Exception) {</span>
<span class="nc" id="L50">            LogUtils.e(&quot;Erreur lors de la récupération de la durée audio depuis URL: &quot;, e)</span>
<span class="nc" id="L51">            0L</span>
        }
    }

    /**
     * Récupère les métadonnées complètes d'un fichier audio
     * @param audioPath Chemin local du fichier audio
     * @return Map des métadonnées, ou map vide si impossible à récupérer
     */
    fun getAudioMetadata(audioPath: String): Map&lt;String, String&gt; {
<span class="nc" id="L61">        return try {</span>
<span class="nc" id="L62">            val retriever = MediaMetadataRetriever()</span>
<span class="nc" id="L63">            retriever.setDataSource(audioPath)</span>

<span class="nc" id="L65">            val metadata = mutableMapOf&lt;String, String&gt;()</span>

            // Durée
<span class="nc bnc" id="L68" title="All 2 branches missed.">            retriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_DURATION)?.let {</span>
<span class="nc" id="L69">                metadata[&quot;duration&quot;] = it</span>
<span class="nc" id="L70">            }</span>

            // Format
<span class="nc bnc" id="L73" title="All 2 branches missed.">            retriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_MIMETYPE)?.let {</span>
<span class="nc" id="L74">                metadata[&quot;mimetype&quot;] = it</span>
<span class="nc" id="L75">            }</span>

            // Taille du fichier
<span class="nc" id="L78">            try {</span>
<span class="nc" id="L79">                val file = File(audioPath)</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                if (file.exists()) {</span>
<span class="nc" id="L81">                    metadata[&quot;filesize&quot;] = file.length().toString()</span>
                }
<span class="nc" id="L83">            } catch (e: Exception) {</span>
<span class="nc" id="L84">                LogUtils.e(&quot;Erreur lors de la récupération de la taille du fichier: &quot;, e)</span>
            }

<span class="nc" id="L87">            retriever.release()</span>
<span class="nc" id="L88">            metadata</span>
<span class="nc" id="L89">        } catch (e: Exception) {</span>
<span class="nc" id="L90">            LogUtils.e(&quot;Erreur lors de la récupération des métadonnées audio: &quot;, e)</span>
<span class="nc" id="L91">            emptyMap()</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>