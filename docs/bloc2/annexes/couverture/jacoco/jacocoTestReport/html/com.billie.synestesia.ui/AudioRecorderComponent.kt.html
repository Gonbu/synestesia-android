<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AudioRecorderComponent.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.billie.synestesia.ui</a> &gt; <span class="el_source">AudioRecorderComponent.kt</span></div><h1>AudioRecorderComponent.kt</h1><pre class="source lang-java linenums">package com.billie.synestesia.ui

import android.content.Context
import androidx.activity.result.ActivityResultLauncher
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import com.billie.synestesia.AudioPlaybackService
import com.billie.synestesia.AudioRecordingService
import com.billie.synestesia.R
import com.billie.synestesia.permission.AudioPermission
import com.billie.synestesia.permission.rememberAudioPermissionLauncher
import com.billie.synestesia.utils.AudioConstants
import com.billie.synestesia.utils.LogUtils
import kotlinx.coroutines.delay

@Composable
<span class="nc bnc" id="L46" title="All 20 branches missed.">fun audioRecorderComponent(onAudioRecorded: (String) -&gt; Unit, modifier: Modifier = Modifier) {</span>
<span class="nc" id="L47">    val audioState = rememberAudioState()</span>
<span class="nc" id="L48">    val context = LocalContext.current</span>
<span class="nc" id="L49">    val audioPermissionLauncher = createAudioPermissionLauncher(context)</span>

<span class="nc" id="L51">    Column(modifier = modifier.fillMaxWidth().padding(16.dp)) {</span>
<span class="nc" id="L52">        audioRecorderHeader()</span>
<span class="nc" id="L53">        audioRecordButton(</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            isRecording = audioState.isRecording,</span>
<span class="nc" id="L55">            onRecordClick = {</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">                if (!audioState.isRecording) {</span>
<span class="nc" id="L57">                    handleStartRecording(context, audioPermissionLauncher) { filePath -&gt;</span>
<span class="nc" id="L58">                        audioState.updateRecordingState(true, filePath)</span>
<span class="nc" id="L59">                    }</span>
                } else {
<span class="nc" id="L61">                    handleStopRecording(context) { filePath -&gt;</span>
<span class="nc" id="L62">                        audioState.updateRecordingState(false, filePath)</span>
<span class="nc" id="L63">                        onAudioRecorded(filePath)</span>
<span class="nc" id="L64">                    }</span>
                }
<span class="nc" id="L66">            }</span>
        )

<span class="nc" id="L69">        Spacer(modifier = Modifier.height(20.dp))</span>

<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (audioState.isRecording) {</span>
<span class="nc" id="L72">            recordingTimeDisplay(audioState.formattedTime)</span>
<span class="nc" id="L73">            Spacer(modifier = Modifier.height(12.dp))</span>
        }

<span class="nc bnc" id="L76" title="All 2 branches missed.">        audioState.audioFilePath?.let { path -&gt;</span>
<span class="nc" id="L77">            Spacer(modifier = Modifier.height(20.dp))</span>
<span class="nc" id="L78">            audioPreviewCard(</span>
<span class="nc" id="L79">                audioPath = path,</span>
<span class="nc" id="L80">                formattedTime = audioState.formattedTime,</span>
<span class="nc" id="L81">                isPlaying = audioState.isPlaying,</span>
<span class="nc" id="L82">                onPlayClick = { /* La gestion de l'état se fait dans le composant */ }</span>
            )
<span class="nc" id="L84">        }</span>

<span class="nc" id="L86">        Spacer(modifier = Modifier.height(20.dp))</span>
<span class="nc" id="L87">        audioInstructions()</span>
<span class="nc" id="L88">    }</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L92" title="All 6 branches missed.">private fun audioRecorderHeader() {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">    Text(</span>
<span class="nc" id="L94">        text = AudioConstants.LABEL_AUDIO_RECORDING,</span>
<span class="nc" id="L95">        style = MaterialTheme.typography.titleMedium,</span>
<span class="nc" id="L96">        modifier = Modifier.padding(bottom = 16.dp)</span>
    )
<span class="nc bnc" id="L98" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L101" title="All 6 branches missed.">private fun audioInstructions() {</span>
<span class="nc" id="L102">    Box(modifier = Modifier.fillMaxWidth(), contentAlignment = Alignment.Center) {</span>
<span class="nc" id="L103">        Text(</span>
<span class="nc" id="L104">            text = AudioConstants.INSTRUCTION_AUDIO_RECORDING,</span>
<span class="nc" id="L105">            style = MaterialTheme.typography.bodySmall,</span>
<span class="nc" id="L106">            color = MaterialTheme.colorScheme.onSurfaceVariant</span>
        )
<span class="nc" id="L108">    }</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">}</span>

@Composable
<span class="nc" id="L112">private fun rememberAudioState(): AudioRecorderState {</span>
<span class="nc" id="L113">    var isRecording by remember { mutableStateOf(false) }</span>
<span class="nc" id="L114">    var recordingTime by remember { mutableStateOf(0L) }</span>
<span class="nc" id="L115">    var audioFilePath by remember { mutableStateOf&lt;String?&gt;(null) }</span>
<span class="nc" id="L116">    var isPlaying by remember { mutableStateOf(false) }</span>

    // Timer pour l'enregistrement
<span class="nc" id="L119">    LaunchedEffect(isRecording) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (isRecording) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            while (isRecording) {</span>
<span class="nc" id="L122">                delay(1000)</span>
<span class="nc" id="L123">                recordingTime++</span>
            }
        }
<span class="nc" id="L126">    }</span>

    // Format du temps d'enregistrement
<span class="nc" id="L129">    val formattedTime =</span>
<span class="nc" id="L130">        remember(recordingTime) {</span>
<span class="nc" id="L131">            val minutes = recordingTime / 60</span>
<span class="nc" id="L132">            val seconds = recordingTime % 60</span>
<span class="nc" id="L133">            String.format(&quot;%02d:%02d&quot;, minutes, seconds)</span>
        }

<span class="nc bnc" id="L136" title="All 2 branches missed.">    return remember {</span>
<span class="nc" id="L137">        AudioRecorderState(</span>
<span class="nc" id="L138">            isRecording = isRecording,</span>
<span class="nc" id="L139">            recordingTime = recordingTime,</span>
<span class="nc" id="L140">            audioFilePath = audioFilePath,</span>
<span class="nc" id="L141">            isPlaying = isPlaying,</span>
<span class="nc" id="L142">            formattedTime = formattedTime,</span>
<span class="nc" id="L143">            updateRecordingState = { recording, filePath -&gt;</span>
<span class="nc" id="L144">                isRecording = recording</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (recording) {</span>
<span class="nc" id="L146">                    recordingTime = 0L</span>
                }
<span class="nc" id="L148">                audioFilePath = filePath</span>
<span class="nc" id="L149">            }</span>
<span class="nc" id="L150">        )</span>
    }
}

@Composable
<span class="nc" id="L155">private fun createAudioPermissionLauncher(context: Context): ActivityResultLauncher&lt;String&gt; {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">    return rememberAudioPermissionLauncher(</span>
<span class="nc" id="L157">        onPermissionGranted = { LogUtils.d(&quot;Permission audio accordée&quot;) },</span>
<span class="nc" id="L158">        onPermissionDenied = {</span>
<span class="nc" id="L159">            LogUtils.showErrorToast(context, AudioConstants.ERROR_AUDIO_PERMISSION_DENIED)</span>
<span class="nc" id="L160">        }</span>
    )
}

@Composable
<span class="nc bnc" id="L165" title="All 14 branches missed.">private fun audioRecordButton(isRecording: Boolean, onRecordClick: () -&gt; Unit) {</span>
<span class="nc" id="L166">    Box(modifier = Modifier.fillMaxWidth(), contentAlignment = Alignment.Center) {</span>
<span class="nc" id="L167">        Button(</span>
<span class="nc" id="L168">            onClick = onRecordClick,</span>
<span class="nc" id="L169">            modifier = Modifier.size(80.dp).clip(CircleShape),</span>
            colors =
<span class="nc" id="L171">            ButtonDefaults.buttonColors(</span>
                containerColor =
<span class="nc bnc" id="L173" title="All 2 branches missed.">                if (isRecording) {</span>
<span class="nc" id="L174">                    Color.Red</span>
                } else {
<span class="nc" id="L176">                    MaterialTheme.colorScheme.primary</span>
                }
            )
<span class="nc" id="L179">        ) {</span>
<span class="nc bnc" id="L180" title="All 8 branches missed.">            Icon(</span>
                painter =
<span class="nc" id="L182">                painterResource(</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                    id = if (isRecording) R.drawable.ic_stop else R.drawable.ic_mic</span>
                ),
                contentDescription =
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (isRecording) {</span>
<span class="nc" id="L187">                    &quot;Arrêter l'enregistrement&quot;</span>
                } else {
<span class="nc" id="L189">                    &quot;Démarrer l'enregistrement&quot;</span>
                },
<span class="nc" id="L191">                modifier = Modifier.size(32.dp),</span>
<span class="nc" id="L192">                tint = MaterialTheme.colorScheme.onPrimary</span>
<span class="nc" id="L193">            )</span>
<span class="nc" id="L194">        }</span>
<span class="nc" id="L195">    }</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L199" title="All 10 branches missed.">private fun recordingTimeDisplay(formattedTime: String) {</span>
<span class="nc" id="L200">    Box(modifier = Modifier.fillMaxWidth(), contentAlignment = Alignment.Center) {</span>
<span class="nc" id="L201">        Text(</span>
<span class="nc" id="L202">            text = &quot;Enregistrement en cours: $formattedTime&quot;,</span>
<span class="nc" id="L203">            style = MaterialTheme.typography.bodyMedium,</span>
<span class="nc" id="L204">            color = Color.Red</span>
        )
<span class="nc" id="L206">    }</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">}</span>

@Composable
private fun audioPreviewCard(
    audioPath: String,
    formattedTime: String,
    isPlaying: Boolean,
    onPlayClick: (Boolean) -&gt; Unit
<span class="nc bnc" id="L215" title="All 22 branches missed.">) {</span>
<span class="nc" id="L216">    val context = LocalContext.current</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">    Card(</span>
<span class="nc" id="L219">        modifier = Modifier.fillMaxWidth(),</span>
        colors =
<span class="nc" id="L221">        CardDefaults.cardColors(</span>
<span class="nc" id="L222">            containerColor = MaterialTheme.colorScheme.surfaceVariant</span>
        ),
<span class="nc" id="L224">        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)</span>
<span class="nc" id="L225">    ) {</span>
<span class="nc bnc" id="L226" title="All 6 branches missed.">        Column(modifier = Modifier.padding(20.dp)) {</span>
<span class="nc" id="L227">            Text(</span>
<span class="nc" id="L228">                text = AudioConstants.LABEL_AUDIO_RECORDED,</span>
<span class="nc" id="L229">                style = MaterialTheme.typography.titleSmall,</span>
<span class="nc" id="L230">                modifier = Modifier.padding(bottom = 12.dp)</span>
            )

<span class="nc" id="L233">            Row(</span>
<span class="nc" id="L234">                modifier = Modifier.fillMaxWidth(),</span>
<span class="nc" id="L235">                horizontalArrangement = Arrangement.SpaceBetween,</span>
<span class="nc" id="L236">                verticalAlignment = Alignment.CenterVertically</span>
            ) {
<span class="nc" id="L238">                Text(</span>
<span class="nc" id="L239">                    text = &quot;${AudioConstants.LABEL_AUDIO_DURATION}: $formattedTime&quot;,</span>
<span class="nc" id="L240">                    style = MaterialTheme.typography.bodyMedium</span>
                )

<span class="nc" id="L243">                audioPlayButton(</span>
<span class="nc" id="L244">                    audioPath = audioPath,</span>
<span class="nc" id="L245">                    isPlaying = isPlaying,</span>
<span class="nc" id="L246">                    onPlayClick = onPlayClick,</span>
<span class="nc" id="L247">                    context = context</span>
                )
<span class="nc" id="L249">            }</span>
<span class="nc" id="L250">        }</span>
<span class="nc" id="L251">    }</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">}</span>

@Composable
private fun audioPlayButton(
    audioPath: String,
    isPlaying: Boolean,
    onPlayClick: (Boolean) -&gt; Unit,
    context: Context
<span class="nc bnc" id="L260" title="All 28 branches missed.">) {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">    IconButton(</span>
<span class="nc" id="L262">        onClick = {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (isPlaying) {</span>
<span class="nc" id="L264">                AudioPlaybackService.stopAudio()</span>
<span class="nc" id="L265">                onPlayClick(false)</span>
            } else {
<span class="nc" id="L267">                onPlayClick(true)</span>
<span class="nc" id="L268">                AudioPlaybackService.playAudio(</span>
<span class="nc" id="L269">                    context = context,</span>
<span class="nc" id="L270">                    audioUrl = audioPath,</span>
                    onProgress = { /* Pas besoin de progression pour la prévisualisation */
<span class="nc" id="L272">                    },</span>
<span class="nc" id="L273">                    onComplete = { onPlayClick(false) },</span>
                    onError = { error -&gt;
<span class="nc" id="L275">                        LogUtils.e(&quot;Erreur de lecture de la prévisualisation: $error&quot;)</span>
<span class="nc" id="L276">                        onPlayClick(false)</span>
<span class="nc" id="L277">                    }</span>
                )
            }
<span class="nc" id="L280">            LogUtils.d(&quot;Lecture audio: $audioPath&quot;)</span>
<span class="nc" id="L281">        },</span>
<span class="nc" id="L282">        modifier = Modifier.size(48.dp)</span>
<span class="nc" id="L283">    ) {</span>
<span class="nc bnc" id="L284" title="All 8 branches missed.">        Icon(</span>
            painter =
<span class="nc" id="L286">            painterResource(</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                id = if (isPlaying) R.drawable.ic_stop else R.drawable.ic_play</span>
            ),
<span class="nc bnc" id="L289" title="All 2 branches missed.">            contentDescription = if (isPlaying) &quot;Arrêter&quot; else &quot;Lecture&quot;,</span>
<span class="nc" id="L290">            tint = MaterialTheme.colorScheme.primary,</span>
<span class="nc" id="L291">            modifier = Modifier.size(28.dp)</span>
<span class="nc" id="L292">        )</span>
<span class="nc" id="L293">    }</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">}</span>

private fun handleStartRecording(
    context: Context,
    audioPermissionLauncher: ActivityResultLauncher&lt;String&gt;,
    onSuccess: (String) -&gt; Unit
) {
<span class="nc bnc" id="L301" title="All 2 branches missed.">    if (AudioPermission.checkAudioPermission(context)) {</span>
<span class="nc" id="L302">        val filePath = AudioRecordingService.startRecording(context)</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (filePath != null) {</span>
<span class="nc" id="L304">            onSuccess(filePath)</span>
<span class="nc" id="L305">            LogUtils.d(AudioConstants.SUCCESS_AUDIO_RECORDING_START)</span>
        } else {
<span class="nc" id="L307">            LogUtils.showErrorToast(context, AudioConstants.ERROR_AUDIO_RECORDING_START)</span>
        }
    } else {
<span class="nc" id="L310">        audioPermissionLauncher.launch(android.Manifest.permission.RECORD_AUDIO)</span>
    }
<span class="nc" id="L312">}</span>

private fun handleStopRecording(context: Context, onSuccess: (String) -&gt; Unit) {
<span class="nc" id="L315">    val filePath = AudioRecordingService.stopRecording()</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">    if (filePath != null) {</span>
<span class="nc" id="L317">        onSuccess(filePath)</span>
<span class="nc" id="L318">        LogUtils.d(AudioConstants.SUCCESS_AUDIO_RECORDING_STOP)</span>
    } else {
<span class="nc" id="L320">        LogUtils.showErrorToast(context, AudioConstants.ERROR_AUDIO_RECORDING_STOP)</span>
    }
<span class="nc" id="L322">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>