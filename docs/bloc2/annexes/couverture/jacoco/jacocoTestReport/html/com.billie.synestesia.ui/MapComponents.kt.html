<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MapComponents.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.billie.synestesia.ui</a> &gt; <span class="el_source">MapComponents.kt</span></div><h1>MapComponents.kt</h1><pre class="source lang-java linenums">package com.billie.synestesia.ui

import android.graphics.Bitmap
import android.graphics.Canvas
import android.graphics.Color
import android.graphics.Paint
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import com.billie.synestesia.FirestoreService
import com.billie.synestesia.R
import com.billie.synestesia.models.SouvenirItem
import com.billie.synestesia.ui.theme.AppColors
import com.billie.synestesia.ui.theme.ColorUtils
import com.billie.synestesia.utils.LogUtils
import com.billie.synestesia.utils.MessageConstants
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.model.BitmapDescriptorFactory
import com.google.android.gms.maps.model.LatLng
import com.google.maps.android.compose.CameraPositionState
import com.google.maps.android.compose.GoogleMap
import com.google.maps.android.compose.MapUiSettings
import com.google.maps.android.compose.Marker
import com.google.maps.android.compose.MarkerState
import com.google.maps.android.compose.rememberCameraPositionState
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext

@Composable
fun MapContent(
    currentLatLng: LatLng?,
    onMapLoaded: () -&gt; Unit,
    coroutineScope: CoroutineScope,
<span class="nc bnc" id="L49" title="All 2 branches missed.">    modifier: Modifier = Modifier</span>
<span class="nc bnc" id="L50" title="All 30 branches missed.">) {</span>
<span class="nc" id="L51">    val cameraPositionState = rememberCameraPositionState()</span>
<span class="nc" id="L52">    val uiSettings = MapUiSettings(myLocationButtonEnabled = false)</span>

<span class="nc" id="L54">    val context = androidx.compose.ui.platform.LocalContext.current</span>
<span class="nc" id="L55">    val scope = rememberCoroutineScope()</span>

<span class="nc" id="L57">    var clickedLatLng by remember { mutableStateOf&lt;LatLng?&gt;(null) }</span>
<span class="nc" id="L58">    var showBottomSheet by remember { mutableStateOf(false) }</span>

    // Variables pour gérer plusieurs souvenirs par point
<span class="nc" id="L61">    var selectedSouvenirs by remember { mutableStateOf&lt;List&lt;SouvenirItem&gt;&gt;(emptyList()) }</span>
<span class="nc" id="L62">    var currentSouvenirIndex by remember { mutableStateOf(0) }</span>

<span class="nc" id="L64">    var souvenirs by remember { mutableStateOf&lt;List&lt;SouvenirItem&gt;&gt;(emptyList()) }</span>
<span class="nc" id="L65">    var isLoading by remember { mutableStateOf(false) }</span>

<span class="nc" id="L67">    var addOnLatLng by remember { mutableStateOf&lt;LatLng?&gt;(null) }</span>
<span class="nc" id="L68">    var showAddOnExistingPoint by remember { mutableStateOf(false) }</span>

<span class="nc" id="L70">    suspend fun reloadSouvenirs() {</span>
<span class="nc" id="L71">        isLoading = true</span>
<span class="nc" id="L72">        try {</span>
<span class="nc" id="L73">            val loaded = withContext(Dispatchers.IO) { FirestoreService.getAllSouvenirs() }</span>
<span class="nc" id="L74">            souvenirs = loaded</span>
<span class="nc" id="L75">        } catch (e: Exception) {</span>
<span class="nc" id="L76">            LogUtils.showToast(context, MessageConstants.ERROR_LOADING_SOUVENIRS)</span>
        } finally {
<span class="nc" id="L78">            isLoading = false</span>
        }
<span class="nc" id="L80">    }</span>

<span class="nc" id="L82">    LaunchedEffect(Unit) { reloadSouvenirs() }</span>

<span class="nc" id="L84">    Box(modifier = modifier) {</span>
<span class="nc" id="L85">        GoogleMap(</span>
<span class="nc" id="L86">            modifier = Modifier.fillMaxSize(),</span>
<span class="nc" id="L87">            onMapLoaded = onMapLoaded,</span>
<span class="nc" id="L88">            cameraPositionState = cameraPositionState,</span>
<span class="nc" id="L89">            uiSettings = uiSettings,</span>
<span class="nc" id="L90">            onMapClick = { latLng -&gt;</span>
<span class="nc" id="L91">                clickedLatLng = latLng</span>
<span class="nc" id="L92">                showBottomSheet = false</span>
<span class="nc" id="L93">            }</span>
<span class="nc" id="L94">        ) {</span>
            // Marqueur de position utilisateur avec taille adaptée au zoom
<span class="nc bnc" id="L96" title="All 8 branches missed.">            currentLatLng?.let { latLng -&gt;</span>
<span class="nc" id="L97">                val userIcon =</span>
<span class="nc" id="L98">                    BitmapDescriptorFactory.fromBitmap(</span>
<span class="nc" id="L99">                        createUserLocationMarker(cameraPositionState.position.zoom)</span>
                    )
<span class="nc" id="L101">                Marker(</span>
<span class="nc" id="L102">                    state = MarkerState(position = latLng),</span>
<span class="nc" id="L103">                    title = &quot;Votre position&quot;,</span>
<span class="nc" id="L104">                    snippet = &quot;Vous êtes ici!&quot;,</span>
<span class="nc" id="L105">                    icon = userIcon</span>
                )
<span class="nc" id="L107">            }</span>

<span class="nc bnc" id="L109" title="All 2 branches missed.">            clickedLatLng?.let { latLng -&gt;</span>
<span class="nc" id="L110">                val clickIcon =</span>
<span class="nc" id="L111">                    BitmapDescriptorFactory.fromBitmap(</span>
<span class="nc" id="L112">                        createIndividualMarker(</span>
<span class="nc" id="L113">                            SouvenirItem(couleur = AppColors.CLICKED_POINT),</span>
<span class="nc" id="L114">                            cameraPositionState.position.zoom</span>
                        )
                    )
<span class="nc" id="L117">                Marker(</span>
<span class="nc" id="L118">                    state = MarkerState(position = latLng),</span>
<span class="nc" id="L119">                    title = &quot;Position sélectionnée&quot;,</span>
<span class="nc" id="L120">                    snippet = &quot;Cliquez pour plus d'infos&quot;,</span>
<span class="nc" id="L121">                    icon = clickIcon,</span>
<span class="nc" id="L122">                    onClick = {</span>
<span class="nc" id="L123">                        coroutineScope.launch {</span>
<span class="nc" id="L124">                            cameraPositionState.animate(</span>
<span class="nc" id="L125">                                CameraUpdateFactory.newLatLng(latLng),</span>
<span class="nc" id="L126">                                1000</span>
                            )
<span class="nc" id="L128">                        }</span>
<span class="nc" id="L129">                        showBottomSheet = true</span>
<span class="nc" id="L130">                        true // Indique que le clic a été géré</span>
                    }
                )
<span class="nc" id="L133">            }</span>

            // Affichage simple de tous les souvenirs
<span class="nc" id="L136">            souvenirs.forEach { souvenir -&gt;</span>
<span class="nc" id="L137">                val markerIcon =</span>
<span class="nc" id="L138">                    BitmapDescriptorFactory.fromBitmap(</span>
<span class="nc" id="L139">                        createIndividualMarker(souvenir, cameraPositionState.position.zoom)</span>
                    )

<span class="nc" id="L142">                Marker(</span>
<span class="nc" id="L143">                    state = MarkerState(position = souvenir.toLatLng()!!),</span>
<span class="nc" id="L144">                    title = souvenir.titre,</span>
<span class="nc" id="L145">                    snippet = souvenir.description,</span>
<span class="nc" id="L146">                    icon = markerIcon,</span>
<span class="nc" id="L147">                    onClick = {</span>
<span class="nc" id="L148">                        coroutineScope.launch {</span>
<span class="nc" id="L149">                            cameraPositionState.animate(</span>
<span class="nc" id="L150">                                CameraUpdateFactory.newLatLng(souvenir.toLatLng()!!),</span>
<span class="nc" id="L151">                                1000</span>
                            )
<span class="nc" id="L153">                        }</span>
<span class="nc" id="L154">                        selectedSouvenirs = listOf(souvenir)</span>
<span class="nc" id="L155">                        currentSouvenirIndex = 0</span>
<span class="nc" id="L156">                        showBottomSheet = true</span>
<span class="nc" id="L157">                        true</span>
                    }
                )
<span class="nc" id="L160">            }</span>
<span class="nc" id="L161">        }</span>

<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (currentLatLng != null) {</span>
<span class="nc" id="L164">            LocationButton(</span>
<span class="nc" id="L165">                currentLatLng = currentLatLng,</span>
<span class="nc" id="L166">                coroutineScope = coroutineScope,</span>
<span class="nc" id="L167">                cameraPositionState = cameraPositionState</span>
            )
        }

<span class="nc" id="L171">        ModalBottomSheetComponent(</span>
<span class="nc" id="L172">            showSheet = showBottomSheet,</span>
<span class="nc" id="L173">            onDismissRequest = {</span>
<span class="nc" id="L174">                showBottomSheet = false</span>
<span class="nc" id="L175">                selectedSouvenirs = emptyList()</span>
<span class="nc" id="L176">                currentSouvenirIndex = 0</span>
<span class="nc" id="L177">                showAddOnExistingPoint = false</span>
<span class="nc" id="L178">                addOnLatLng = null</span>
<span class="nc" id="L179">            },</span>
            backgroundColor =
<span class="nc" id="L181">            when {</span>
<span class="nc bnc" id="L182" title="All 4 branches missed.">                selectedSouvenirs.isNotEmpty() -&gt; {</span>
<span class="nc" id="L183">                    val currentSouvenir = selectedSouvenirs[currentSouvenirIndex]</span>
<span class="nc" id="L184">                    ColorUtils.hexToComposeColor(currentSouvenir.couleur)</span>
                }
<span class="nc bnc" id="L186" title="All 2 branches missed.">                showAddOnExistingPoint -&gt; {</span>
                    // Utiliser la couleur du souvenir existant sur ce point
<span class="nc" id="L188">                    val existingSouvenirs =</span>
<span class="nc" id="L189">                        souvenirs.filter { souvenir -&gt;</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">                            souvenir.toLatLng()?.latitude ==</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                                addOnLatLng?.latitude &amp;&amp;</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">                                souvenir.toLatLng()?.longitude ==</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                                addOnLatLng?.longitude</span>
                        }
<span class="nc bnc" id="L195" title="All 4 branches missed.">                    if (existingSouvenirs.isNotEmpty()) {</span>
<span class="nc" id="L196">                        ColorUtils.hexToComposeColor(existingSouvenirs.first().couleur)</span>
                    } else {
<span class="nc" id="L198">                        ColorUtils.hexToComposeColor(AppColors.LIGHT_PURPLE)</span>
                    }
                }
                else -&gt; {
                    // Couleur rose/violet pâle pour le formulaire d'ajout sur nouveau
                    // point
<span class="nc" id="L204">                    ColorUtils.hexToComposeColor(AppColors.LIGHT_PINK)</span>
                }
            }
<span class="nc" id="L207">        ) {</span>
<span class="nc bnc" id="L208" title="All 10 branches missed.">            if (selectedSouvenirs.isNotEmpty()) {</span>
<span class="nc" id="L209">                val currentSouvenir = selectedSouvenirs[currentSouvenirIndex]</span>
<span class="nc" id="L210">                souvenirDetailCard(</span>
<span class="nc" id="L211">                    souvenirs = selectedSouvenirs,</span>
<span class="nc" id="L212">                    currentIndex = currentSouvenirIndex,</span>
<span class="nc" id="L213">                    onAddSouvenir = {</span>
<span class="nc" id="L214">                        addOnLatLng = currentSouvenir.toLatLng()</span>
<span class="nc" id="L215">                        showAddOnExistingPoint = true</span>
<span class="nc" id="L216">                        selectedSouvenirs =</span>
<span class="nc" id="L217">                            emptyList() // Vider la liste pour afficher le formulaire</span>
<span class="nc" id="L218">                        currentSouvenirIndex = 0</span>
<span class="nc" id="L219">                    },</span>
<span class="nc" id="L220">                    onDeleteSouvenir = {</span>
<span class="nc" id="L221">                        scope.launch {</span>
<span class="nc" id="L222">                            try {</span>
                                // Vérifier que l'utilisateur est bien le propriétaire
<span class="nc" id="L224">                                val currentUser =</span>
<span class="nc" id="L225">                                    com.google.firebase.auth.FirebaseAuth.getInstance()</span>
<span class="nc" id="L226">                                        .currentUser</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">                                if (currentUser?.uid != currentSouvenir.userId) {</span>
<span class="nc" id="L228">                                    LogUtils.showErrorToast(</span>
<span class="nc" id="L229">                                        context,</span>
<span class="nc" id="L230">                                        &quot;Vous ne pouvez pas supprimer ce souvenir&quot;</span>
                                    )
<span class="nc" id="L232">                                    return@launch</span>
                                }

<span class="nc" id="L235">                                FirestoreService.deleteSouvenir(currentSouvenir)</span>
<span class="nc" id="L236">                                reloadSouvenirs()</span>
<span class="nc" id="L237">                                LogUtils.showToast(context, MessageConstants.SOUVENIR_DELETED)</span>

                                // Mettre à jour la liste des souvenirs sélectionnés
<span class="nc" id="L240">                                val updatedSouvenirs =</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                                    selectedSouvenirs.filter { it.id != currentSouvenir.id }</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                                if (updatedSouvenirs.isEmpty()) {</span>
<span class="nc" id="L243">                                    showBottomSheet = false</span>
<span class="nc" id="L244">                                    selectedSouvenirs = emptyList()</span>
<span class="nc" id="L245">                                    currentSouvenirIndex = 0</span>
                                } else {
<span class="nc" id="L247">                                    selectedSouvenirs = updatedSouvenirs</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                                    if (currentSouvenirIndex &gt;= updatedSouvenirs.size) {</span>
<span class="nc" id="L249">                                        currentSouvenirIndex = updatedSouvenirs.size - 1</span>
                                    }
                                }
<span class="nc" id="L252">                            } catch (e: Exception) {</span>
<span class="nc" id="L253">                                LogUtils.e(&quot;Erreur lors de la suppression: &quot;, e)</span>
<span class="nc" id="L254">                                LogUtils.showErrorToast(</span>
<span class="nc" id="L255">                                    context,</span>
<span class="nc" id="L256">                                    MessageConstants.ERROR_DELETING_SOUVENIR</span>
                                )
                            }
<span class="nc" id="L259">                        }</span>
<span class="nc" id="L260">                    },</span>
<span class="nc" id="L261">                    onClose = {</span>
<span class="nc" id="L262">                        showBottomSheet = false</span>
<span class="nc" id="L263">                        selectedSouvenirs = emptyList()</span>
<span class="nc" id="L264">                        currentSouvenirIndex = 0</span>
<span class="nc" id="L265">                        showAddOnExistingPoint = false</span>
<span class="nc" id="L266">                        addOnLatLng = null</span>
<span class="nc" id="L267">                    },</span>
<span class="nc" id="L268">                    onNavigateToSouvenir = { newIndex -&gt; currentSouvenirIndex = newIndex }</span>
                )
<span class="nc bnc" id="L270" title="All 4 branches missed.">            } else if (showAddOnExistingPoint &amp;&amp; addOnLatLng != null) {</span>
                // Formulaire d'ajout sur un point existant
<span class="nc" id="L272">                souvenirFormSheet(</span>
<span class="nc" id="L273">                    latLng = addOnLatLng,</span>
<span class="nc" id="L274">                    onSaveClick = { _ -&gt;</span>
<span class="nc" id="L275">                        scope.launch {</span>
<span class="nc" id="L276">                            try {</span>
                                // Le souvenir a déjà été créé dans le formulaire, on recharge
                                // juste la liste
<span class="nc" id="L279">                                reloadSouvenirs()</span>

                                // Mettre à jour la liste des souvenirs sélectionnés si on était
                                // sur un point existant
<span class="nc bnc" id="L283" title="All 2 branches missed.">                                if (addOnLatLng != null) {</span>
<span class="nc" id="L284">                                    val updatedSouvenirs =</span>
<span class="nc" id="L285">                                        souvenirs.filter { souvenir -&gt;</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">                                            souvenir.toLatLng()?.latitude ==</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                                                addOnLatLng?.latitude &amp;&amp;</span>
<span class="nc bnc" id="L288" title="All 4 branches missed.">                                                souvenir.toLatLng()?.longitude ==</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                                                addOnLatLng?.longitude</span>
                                        }
<span class="nc bnc" id="L291" title="All 4 branches missed.">                                    if (updatedSouvenirs.isNotEmpty()) {</span>
<span class="nc" id="L292">                                        selectedSouvenirs = updatedSouvenirs</span>
<span class="nc" id="L293">                                        currentSouvenirIndex =</span>
<span class="nc" id="L294">                                            updatedSouvenirs.size -</span>
<span class="nc" id="L295">                                            1 // Aller au nouveau souvenir</span>
                                    }
                                }

<span class="nc" id="L299">                                LogUtils.showToast(context, MessageConstants.SOUVENIR_SAVED)</span>
<span class="nc" id="L300">                            } catch (e: Exception) {</span>
<span class="nc" id="L301">                                LogUtils.showErrorToast(</span>
<span class="nc" id="L302">                                    context,</span>
<span class="nc" id="L303">                                    MessageConstants.ERROR_SAVING_SOUVENIR</span>
                                )
                            }
<span class="nc" id="L306">                            showAddOnExistingPoint = false</span>
<span class="nc" id="L307">                            addOnLatLng = null</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                            if (selectedSouvenirs.isEmpty()) {</span>
<span class="nc" id="L309">                                showBottomSheet = false</span>
                            }
<span class="nc" id="L311">                        }</span>
<span class="nc" id="L312">                    }</span>
                )
<span class="nc bnc" id="L314" title="All 2 branches missed.">            } else {</span>
                // Affiche le formulaire d'ajout si aucun souvenir sélectionné
<span class="nc" id="L316">                souvenirFormSheet(</span>
<span class="nc" id="L317">                    latLng = clickedLatLng,</span>
<span class="nc" id="L318">                    onSaveClick = { _ -&gt;</span>
<span class="nc" id="L319">                        scope.launch {</span>
<span class="nc" id="L320">                            try {</span>
                                // Le souvenir a déjà été créé dans le formulaire, on recharge
                                // juste la liste
<span class="nc" id="L323">                                reloadSouvenirs() // Recharge la liste après ajout</span>
<span class="nc" id="L324">                                LogUtils.showToast(context, MessageConstants.SOUVENIR_SAVED)</span>
<span class="nc" id="L325">                                showBottomSheet = false</span>
<span class="nc" id="L326">                            } catch (e: Exception) {</span>
<span class="nc" id="L327">                                LogUtils.showErrorToast(</span>
<span class="nc" id="L328">                                    context,</span>
<span class="nc" id="L329">                                    MessageConstants.ERROR_SAVING_SOUVENIR</span>
                                )
                            }
<span class="nc" id="L332">                        }</span>
<span class="nc" id="L333">                    }</span>
                )
<span class="nc" id="L335">            }</span>
<span class="nc" id="L336">        }</span>
<span class="nc" id="L337">    }</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">}</span>

@Composable
private fun LocationButton(
    currentLatLng: LatLng,
    coroutineScope: CoroutineScope,
    cameraPositionState: CameraPositionState
<span class="nc bnc" id="L345" title="All 20 branches missed.">) {</span>
<span class="nc" id="L346">    Box(</span>
<span class="nc" id="L347">        modifier = Modifier.fillMaxSize().padding(16.dp),</span>
<span class="nc" id="L348">        contentAlignment = Alignment.BottomCenter</span>
    ) {
<span class="nc bnc" id="L350" title="All 6 branches missed.">        IconButton(</span>
<span class="nc" id="L351">            onClick = {</span>
<span class="nc" id="L352">                coroutineScope.launch {</span>
                    // Zoomer sur la position utilisateur avec un niveau de zoom approprié
<span class="nc" id="L354">                    cameraPositionState.animate(</span>
<span class="nc" id="L355">                        CameraUpdateFactory.newLatLngZoom(currentLatLng, 15f),</span>
<span class="nc" id="L356">                        1000</span>
                    )
<span class="nc" id="L358">                }</span>
<span class="nc" id="L359">            }</span>
<span class="nc" id="L360">        ) {</span>
<span class="nc bnc" id="L361" title="All 8 branches missed.">            Icon(</span>
<span class="nc" id="L362">                painter = painterResource(id = R.drawable.ic_crosshair),</span>
<span class="nc" id="L363">                contentDescription = &quot;Aller à ma position&quot;</span>
<span class="nc" id="L364">            )</span>
<span class="nc" id="L365">        }</span>
<span class="nc" id="L366">    }</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">}</span>

// Fonctions simples de création de marqueurs (remplacement du clustering)
private fun createUserLocationMarker(zoomLevel: Float): Bitmap {
<span class="nc" id="L371">    val size = calculateMarkerSize(zoomLevel, false)</span>
<span class="nc" id="L372">    val bitmap = Bitmap.createBitmap(size, size, Bitmap.Config.ARGB_8888)</span>
<span class="nc" id="L373">    val canvas = Canvas(bitmap)</span>
<span class="nc" id="L374">    val paint =</span>
<span class="nc" id="L375">        Paint().apply {</span>
<span class="nc" id="L376">            color = Color.BLUE</span>
<span class="nc" id="L377">            isAntiAlias = true</span>
<span class="nc" id="L378">            style = Paint.Style.FILL</span>
<span class="nc" id="L379">        }</span>

    // Cercle bleu pour la position utilisateur
<span class="nc" id="L382">    canvas.drawCircle(size / 2f, size / 2f, size / 3f, paint)</span>

    // Bordure blanche
<span class="nc" id="L385">    paint.color = Color.WHITE</span>
<span class="nc" id="L386">    paint.style = Paint.Style.STROKE</span>
<span class="nc" id="L387">    paint.strokeWidth = size / 20f</span>
<span class="nc" id="L388">    canvas.drawCircle(size / 2f, size / 2f, size / 3f, paint)</span>

<span class="nc" id="L390">    return bitmap</span>
}

private fun createIndividualMarker(souvenir: SouvenirItem, zoomLevel: Float): Bitmap {
<span class="nc" id="L394">    val size = calculateMarkerSize(zoomLevel, false)</span>
<span class="nc" id="L395">    val bitmap = Bitmap.createBitmap(size, size, Bitmap.Config.ARGB_8888)</span>
<span class="nc" id="L396">    val canvas = Canvas(bitmap)</span>
<span class="nc" id="L397">    val paint =</span>
<span class="nc" id="L398">        Paint().apply {</span>
<span class="nc" id="L399">            color = ColorUtils.hexToAndroidColor(souvenir.couleur)</span>
<span class="nc" id="L400">            isAntiAlias = true</span>
<span class="nc" id="L401">            style = Paint.Style.FILL</span>
<span class="nc" id="L402">        }</span>

    // Cercle coloré pour le souvenir
<span class="nc" id="L405">    canvas.drawCircle(size / 2f, size / 2f, size / 3f, paint)</span>

    // Bordure blanche
<span class="nc" id="L408">    paint.color = Color.WHITE</span>
<span class="nc" id="L409">    paint.style = Paint.Style.STROKE</span>
<span class="nc" id="L410">    paint.strokeWidth = size / 20f</span>
<span class="nc" id="L411">    canvas.drawCircle(size / 2f, size / 2f, size / 3f, paint)</span>

<span class="nc" id="L413">    return bitmap</span>
}

private fun calculateMarkerSize(zoomLevel: Float, isCluster: Boolean): Int {
<span class="nc" id="L417">    return when {</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        zoomLevel &gt;= 15f -&gt; 60 // Zoom élevé : marqueurs petits</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        zoomLevel &gt;= 12f -&gt; 70 // Zoom moyen : marqueurs moyens</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">        zoomLevel &gt;= 8f -&gt; 80 // Zoom faible : marqueurs grands</span>
<span class="nc" id="L421">        else -&gt; 90 // Zoom très faible : marqueurs très grands</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>