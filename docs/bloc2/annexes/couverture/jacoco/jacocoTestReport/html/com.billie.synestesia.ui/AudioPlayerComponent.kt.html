<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AudioPlayerComponent.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.billie.synestesia.ui</a> &gt; <span class="el_source">AudioPlayerComponent.kt</span></div><h1>AudioPlayerComponent.kt</h1><pre class="source lang-java linenums">package com.billie.synestesia.ui

import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.LinearProgressIndicator
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.DisposableEffect
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import com.billie.synestesia.AudioMetadataService
import com.billie.synestesia.AudioPlaybackService
import com.billie.synestesia.R
import com.billie.synestesia.utils.AudioConstants
import com.billie.synestesia.utils.LogUtils

<span class="nc" id="L37">data class AudioPlayerState(</span>
<span class="nc" id="L38">    val currentPosition: Long,</span>
<span class="nc" id="L39">    val duration: Long,</span>
<span class="nc" id="L40">    val isPlaying: Boolean,</span>
<span class="nc" id="L41">    val isPaused: Boolean</span>
)

<span class="nc" id="L44">data class AudioPlayerCallbacks(val onPlayPause: () -&gt; Unit, val onStop: () -&gt; Unit)</span>

@Composable
<span class="nc bnc" id="L47" title="All 6 branches missed.">private fun audioPlayerHeader() {</span>
<span class="nc" id="L48">    Row(modifier = Modifier.fillMaxWidth(), verticalAlignment = Alignment.CenterVertically) {</span>
<span class="nc" id="L49">        Icon(</span>
<span class="nc" id="L50">            painter = painterResource(id = R.drawable.ic_sound_on),</span>
<span class="nc" id="L51">            contentDescription = &quot;Audio&quot;,</span>
<span class="nc" id="L52">            tint = MaterialTheme.colorScheme.primary,</span>
<span class="nc" id="L53">            modifier = Modifier.size(28.dp)</span>
        )

<span class="nc" id="L56">        Spacer(modifier = Modifier.width(12.dp))</span>

<span class="nc" id="L58">        Text(</span>
<span class="nc" id="L59">            text = AudioConstants.LABEL_AUDIO_PLAYBACK,</span>
<span class="nc" id="L60">            style = MaterialTheme.typography.titleSmall</span>
        )
<span class="nc" id="L62">    }</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L66" title="All 18 branches missed.">private fun audioPlayerProgress(currentPosition: Long, duration: Long) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">    LinearProgressIndicator(</span>
<span class="nc" id="L68">        progress = {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (duration &gt; 0) {</span>
<span class="nc" id="L70">                (currentPosition.toFloat() / duration.toFloat())</span>
            } else {
<span class="nc" id="L72">                0f</span>
<span class="nc" id="L73">            }</span>
        },
<span class="nc" id="L75">        modifier = Modifier.fillMaxWidth()</span>
    )
<span class="nc bnc" id="L77" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L80" title="All 14 branches missed.">private fun audioPlayerTimeDisplay(currentPosition: Long, duration: Long) {</span>
<span class="nc" id="L81">    val formatTime = { timeMs: Long -&gt;</span>
<span class="nc" id="L82">        val seconds = (timeMs / 1000).toInt()</span>
<span class="nc" id="L83">        val minutes = seconds / 60</span>
<span class="nc" id="L84">        val remainingSeconds = seconds % 60</span>
<span class="nc" id="L85">        String.format(&quot;%02d:%02d&quot;, minutes, remainingSeconds)</span>
    }

<span class="nc bnc" id="L88" title="All 2 branches missed.">    Text(</span>
<span class="nc" id="L89">        text = &quot;${formatTime(currentPosition)} / ${formatTime(duration)}&quot;,</span>
<span class="nc" id="L90">        style = MaterialTheme.typography.bodySmall,</span>
<span class="nc" id="L91">        color = MaterialTheme.colorScheme.onSurfaceVariant</span>
    )
<span class="nc bnc" id="L93" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L96" title="All 18 branches missed.">private fun audioPlayerButton(iconId: Int, contentDescription: String, onClick: () -&gt; Unit) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">    IconButton(onClick = onClick, modifier = Modifier.size(48.dp)) {</span>
<span class="nc bnc" id="L98" title="All 8 branches missed.">        Icon(</span>
<span class="nc" id="L99">            painter = painterResource(id = iconId),</span>
<span class="nc" id="L100">            contentDescription = contentDescription,</span>
<span class="nc" id="L101">            tint = MaterialTheme.colorScheme.primary,</span>
<span class="nc" id="L102">            modifier = Modifier.size(28.dp)</span>
<span class="nc" id="L103">        )</span>
<span class="nc" id="L104">    }</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L108" title="All 14 branches missed.">private fun audioPlayerControls(state: AudioPlayerState, callbacks: AudioPlayerCallbacks) {</span>
<span class="nc" id="L109">    Row(</span>
<span class="nc" id="L110">        modifier = Modifier.fillMaxWidth(),</span>
<span class="nc" id="L111">        horizontalArrangement = Arrangement.SpaceBetween,</span>
<span class="nc" id="L112">        verticalAlignment = Alignment.CenterVertically</span>
    ) {
<span class="nc" id="L114">        audioPlayerTimeDisplay(state.currentPosition, state.duration)</span>

<span class="nc" id="L116">        Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {</span>
<span class="nc" id="L117">            audioPlayerButton(</span>
                iconId =
<span class="nc bnc" id="L119" title="All 4 branches missed.">                if (state.isPlaying &amp;&amp; !state.isPaused) {</span>
<span class="nc" id="L120">                    R.drawable.ic_pause</span>
                } else {
<span class="nc" id="L122">                    R.drawable.ic_play</span>
                },
                contentDescription =
<span class="nc bnc" id="L125" title="All 4 branches missed.">                if (state.isPlaying &amp;&amp; !state.isPaused) &quot;Pause&quot; else &quot;Lecture&quot;,</span>
<span class="nc" id="L126">                onClick = callbacks.onPlayPause</span>
            )
<span class="nc" id="L128">            audioPlayerButton(</span>
<span class="nc" id="L129">                iconId = R.drawable.ic_stop,</span>
<span class="nc" id="L130">                contentDescription = &quot;Arrêter&quot;,</span>
<span class="nc" id="L131">                onClick = callbacks.onStop</span>
            )
<span class="nc" id="L133">        }</span>
<span class="nc" id="L134">    }</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">}</span>

@Composable
private fun audioPlayerState(
    audioUrl: String,
    onDurationLoaded: (Long) -&gt; Unit,
    onProgressUpdate: (Long) -&gt; Unit,
    onPlaybackComplete: () -&gt; Unit,
    onPlaybackError: (String) -&gt; Unit
<span class="nc bnc" id="L144" title="All 26 branches missed.">) {</span>
    // Récupérer la vraie durée de l'audio
<span class="nc bnc" id="L146" title="All 6 branches missed.">    LaunchedEffect(audioUrl) {</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">        if (audioUrl.isNotEmpty()) {</span>
<span class="nc" id="L148">            try {</span>
<span class="nc" id="L149">                val audioDuration = AudioMetadataService.getAudioDurationFromUrl(audioUrl)</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                if (audioDuration &gt; 0) {</span>
<span class="nc" id="L151">                    onDurationLoaded(audioDuration)</span>
<span class="nc" id="L152">                    LogUtils.d(&quot;Durée audio récupérée: ${audioDuration}ms&quot;)</span>
                } else {
<span class="nc" id="L154">                    onDurationLoaded(10000L) // 10 secondes par défaut</span>
<span class="nc" id="L155">                    LogUtils.w(</span>
<span class="nc" id="L156">                        &quot;Impossible de récupérer la durée audio, utilisation de la valeur par défaut&quot;</span>
                    )
                }
<span class="nc" id="L159">            } catch (e: Exception) {</span>
<span class="nc" id="L160">                LogUtils.e(&quot;Erreur lors de la récupération de la durée audio: &quot;, e)</span>
<span class="nc" id="L161">                onDurationLoaded(10000L) // 10 secondes par défaut</span>
            }
        }
<span class="nc" id="L164">    }</span>

    // Gestion de la lecture audio
<span class="nc bnc" id="L167" title="All 8 branches missed.">    LaunchedEffect(Unit) {</span>
<span class="nc" id="L168">        AudioPlaybackService.setProgressCallback { position -&gt; onProgressUpdate(position) }</span>
<span class="nc" id="L169">        AudioPlaybackService.setCompletionCallback { onPlaybackComplete() }</span>
<span class="nc" id="L170">        AudioPlaybackService.setErrorCallback { error -&gt; onPlaybackError(error) }</span>
<span class="nc" id="L171">    }</span>

    // Nettoyage à la destruction du composant
<span class="nc bnc" id="L174" title="All 2 branches missed.">    DisposableEffect(Unit) { onDispose { AudioPlaybackService.cleanup() } }</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">}</span>

@Composable
private fun audioPlayerPlaybackLogic(
    state: AudioPlayerState,
    audioUrl: String,
    context: android.content.Context,
    onStateChange: (Boolean, Boolean, Long) -&gt; Unit
<span class="nc bnc" id="L183" title="All 28 branches missed.">) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">    val handlePlayPause = {</span>
<span class="nc bnc" id="L185" title="All 4 branches missed.">        if (state.isPlaying &amp;&amp; !state.isPaused) {</span>
<span class="nc" id="L186">            AudioPlaybackService.pauseAudio()</span>
<span class="nc" id="L187">            onStateChange(state.isPlaying, true, 0L)</span>
<span class="nc" id="L188">            LogUtils.d(&quot;Audio mis en pause&quot;)</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">        } else if (state.isPlaying &amp;&amp; state.isPaused) {</span>
<span class="nc" id="L190">            AudioPlaybackService.resumeAudio()</span>
<span class="nc" id="L191">            onStateChange(state.isPlaying, false, 0L)</span>
<span class="nc" id="L192">            LogUtils.d(&quot;Audio repris&quot;)</span>
        } else {
<span class="nc" id="L194">            onStateChange(true, false, 0L)</span>
<span class="nc" id="L195">            AudioPlaybackService.playAudio(</span>
<span class="nc" id="L196">                context = context,</span>
<span class="nc" id="L197">                audioUrl = audioUrl,</span>
                onProgress = { position -&gt;
<span class="nc" id="L199">                    onStateChange(state.isPlaying, state.isPaused, position)</span>
<span class="nc" id="L200">                },</span>
<span class="nc" id="L201">                onComplete = { onStateChange(false, false, 0L) },</span>
                onError = { error -&gt;
<span class="nc" id="L203">                    LogUtils.e(&quot;Erreur de lecture: $error&quot;)</span>
<span class="nc" id="L204">                    onStateChange(false, false, 0L)</span>
<span class="nc" id="L205">                }</span>
            )
<span class="nc" id="L207">            LogUtils.d(&quot;Lecture audio démarrée: $audioUrl&quot;)</span>
        }
<span class="nc" id="L209">    }</span>

<span class="nc" id="L211">    val handleStop = {</span>
<span class="nc" id="L212">        AudioPlaybackService.stopAudio()</span>
<span class="nc" id="L213">        onStateChange(false, false, 0L)</span>
<span class="nc" id="L214">    }</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">    audioPlayerControls(</span>
<span class="nc" id="L217">        state = state,</span>
<span class="nc" id="L218">        callbacks = AudioPlayerCallbacks(onPlayPause = handlePlayPause, onStop = handleStop)</span>
    )
<span class="nc bnc" id="L220" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L223" title="All 20 branches missed.">fun audioPlayerComponent(audioUrl: String, modifier: Modifier = Modifier) {</span>
<span class="nc" id="L224">    var isPlaying by remember { mutableStateOf(false) }</span>
<span class="nc" id="L225">    var isPaused by remember { mutableStateOf(false) }</span>
<span class="nc" id="L226">    var currentPosition by remember { mutableStateOf(0L) }</span>
<span class="nc" id="L227">    var duration by remember { mutableStateOf(0L) }</span>
<span class="nc" id="L228">    val context = LocalContext.current</span>

    // Gestion des événements audio
<span class="nc" id="L231">    audioPlayerState(</span>
<span class="nc" id="L232">        audioUrl = audioUrl,</span>
<span class="nc" id="L233">        onDurationLoaded = { duration = it },</span>
<span class="nc" id="L234">        onProgressUpdate = { currentPosition = it },</span>
<span class="nc" id="L235">        onPlaybackComplete = {</span>
<span class="nc" id="L236">            isPlaying = false</span>
<span class="nc" id="L237">            isPaused = false</span>
<span class="nc" id="L238">            currentPosition = 0L</span>
<span class="nc" id="L239">        },</span>
<span class="nc" id="L240">        onPlaybackError = { error -&gt;</span>
<span class="nc" id="L241">            LogUtils.e(&quot;Erreur de lecture audio: $error&quot;)</span>
<span class="nc" id="L242">            isPlaying = false</span>
<span class="nc" id="L243">            isPaused = false</span>
<span class="nc" id="L244">        }</span>
    )

<span class="nc bnc" id="L247" title="All 2 branches missed.">    Card(</span>
<span class="nc" id="L248">        modifier = modifier.fillMaxWidth(),</span>
        colors =
<span class="nc" id="L250">        CardDefaults.cardColors(</span>
<span class="nc" id="L251">            containerColor = MaterialTheme.colorScheme.surfaceVariant</span>
        ),
<span class="nc" id="L253">        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)</span>
<span class="nc" id="L254">    ) {</span>
<span class="nc bnc" id="L255" title="All 6 branches missed.">        Column(modifier = Modifier.padding(20.dp)) {</span>
<span class="nc" id="L256">            audioPlayerHeader()</span>
<span class="nc" id="L257">            Spacer(modifier = Modifier.height(16.dp))</span>
<span class="nc" id="L258">            audioPlayerProgress(currentPosition, duration)</span>
<span class="nc" id="L259">            Spacer(modifier = Modifier.height(12.dp))</span>
<span class="nc" id="L260">            audioPlayerPlaybackLogic(</span>
                state =
<span class="nc" id="L262">                AudioPlayerState(</span>
<span class="nc" id="L263">                    currentPosition = currentPosition,</span>
<span class="nc" id="L264">                    duration = duration,</span>
<span class="nc" id="L265">                    isPlaying = isPlaying,</span>
<span class="nc" id="L266">                    isPaused = isPaused</span>
                ),
<span class="nc" id="L268">                audioUrl = audioUrl,</span>
<span class="nc" id="L269">                context = context,</span>
<span class="nc" id="L270">                onStateChange = { newIsPlaying, newIsPaused, newPosition -&gt;</span>
<span class="nc" id="L271">                    isPlaying = newIsPlaying</span>
<span class="nc" id="L272">                    isPaused = newIsPaused</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                    if (newPosition &gt; 0) currentPosition = newPosition</span>
<span class="nc" id="L274">                }</span>
            )
<span class="nc" id="L276">        }</span>
<span class="nc" id="L277">    }</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>